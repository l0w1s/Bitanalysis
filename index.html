<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sir BAP AI - Análise SMC</title>
    <!-- Tailwind CSS para Estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            background-color: #111827; /* bg-gray-900 */
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { 
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">

    <div id="app-container" class="max-w-3xl mx-auto p-4 sm:p-8">
        
        <header class="text-center mb-8">
            <div class="flex items-center justify-center mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                <h1 class="text-4xl sm:text-5xl font-bold ml-3 bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500">
                    Sir BAP AI
                </h1>
            </div>
            <!-- Preço Live -->
            <div id="price-display" class="flex items-center justify-center text-3xl font-bold text-white my-4" style="display: none;">
                <span class="relative flex h-3 w-3 mr-3">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                </span>
                <span id="current-price">--</span>
            </div>
            <p class="text-gray-400">Análise de Smart Money Concepts para Bitcoin (BTC)</p>
        </header>

        <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4 mb-8 flex flex-col sm:flex-row items-center justify-center gap-6 flex-wrap">
            <div class="flex items-center gap-2">
                <span class="font-semibold">Tempo Gráfico:</span>
                <select id="timeframe-selector" class="bg-gray-700 text-white rounded-md p-2 text-sm font-bold transition-colors w-full sm:w-auto">
                    <option value="1h">1 Hora</option>
                    <option value="1d">Diário</option>
                </select>
            </div>
            <button id="analyze-button" class="bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white font-bold py-3 px-8 rounded-md transition-all duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center shadow-lg hover:shadow-cyan-500/50 w-full sm:w-auto text-lg">
                Analisar
            </button>
        </div>

        <div id="loader" class="text-center p-8 text-cyan-400" style="display: none;">A analisar os dados...</div>
        <div id="error-message" class="bg-red-900/50 text-red-300 p-4 rounded-lg text-center mb-4" style="display: none;"></div>
        
        <div id="analysis-result" class="bg-gray-800/30 rounded-lg p-6" style="display: none;"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const dom = {
            analyzeButton: document.getElementById('analyze-button'),
            loader: document.getElementById('loader'),
            errorMessage: document.getElementById('error-message'),
            analysisResultContainer: document.getElementById('analysis-result'),
            timeframeSelector: document.getElementById('timeframe-selector'),
            priceDisplay: document.getElementById('price-display'),
            currentPriceElement: document.getElementById('current-price'),
        };

        const ta = {
            getSwingPoints: (candles, lookback) => {
                let swings = [];
                if (!candles || candles.length < (lookback * 2 + 1)) return [];
                for(let i = lookback; i < candles.length - lookback; i++) {
                    const highSlice = candles.slice(i - lookback, i + lookback + 1).map(c => c.h);
                    const lowSlice = candles.slice(i - lookback, i + lookback + 1).map(c => c.l);
                    if (candles[i].h >= Math.max(...highSlice)) swings.push({ type: 'high', candle: candles[i], index: i });
                    if (candles[i].l <= Math.min(...lowSlice)) swings.push({ type: 'low', candle: candles[i], index: i });
                }
                return swings;
            },
            getFVG: (candles) => {
                let bullishFVG = null;
                let bearishFVG = null;
                if (!candles || candles.length < 3) return { bullish: null, bearish: null };

                for (let i = candles.length - 3; i > 0; i--) {
                    const candle1 = candles[i];
                    const candle3 = candles[i + 2];

                    if (!bullishFVG && candle1.h < candle3.l) {
                        bullishFVG = { high: candle3.l, low: candle1.h };
                    }
                    if (!bearishFVG && candle1.l > candle3.h) {
                        bearishFVG = { high: candle1.l, low: candle3.h };
                    }
                    if (bullishFVG && bearishFVG) break;
                }
                return { bullish: bullishFVG, bearish: bearishFVG };
            }
        };
        
        const smcAnalysis = (candles, lookback) => {
            let report = { 
                bias: "LATERAL", 
                demandZone: null, supplyZone: null, 
                bullishFVG: null, bearishFVG: null,
                buyPlan: null, sellPlan: null
            };
            const swings = ta.getSwingPoints(candles, lookback);
            if (swings.length < 4) return report;

            const highs = swings.filter(s => s.type === 'high');
            const lows = swings.filter(s => s.type === 'low');
            if (highs.length < 2 || lows.length < 2) return report;

            const lastHigh = highs.at(-1);
            const prevHigh = highs.at(-2);
            const lastLow = lows.at(-1);
            const prevLow = lows.at(-2);
            
            if (lastHigh.candle.h > prevHigh.candle.h && lastLow.candle.l > prevLow.candle.l) {
                report.bias = 'ALTA';
            } else if (lastLow.candle.l < prevLow.candle.l && lastHigh.candle.h < prevHigh.candle.h) {
                report.bias = 'BAIXA';
            }

            if (report.bias === 'ALTA') {
                const candlesAroundLastLow = candles.slice(Math.max(0, lastLow.index - lookback), lastLow.index + 1);
                const downCandleAtHL = candlesAroundLastLow.filter(c => c.o > c.c).pop();
                if(downCandleAtHL) report.demandZone = { low: downCandleAtHL.l, high: downCandleAtHL.h };
            } else if (report.bias === 'BAIXA') {
                const candlesAroundLastHigh = candles.slice(Math.max(0, lastHigh.index - lookback), lastHigh.index + 1);
                const upCandleAtLH = candlesAroundLastHigh.filter(c => c.c > c.o).pop();
                if(upCandleAtLH) report.supplyZone = { low: upCandleAtLH.l, high: upCandleAtLH.h };
            }

            const fvgs = ta.getFVG(candles);
            report.bullishFVG = fvgs.bullish;
            report.bearishFVG = fvgs.bearish;

            if (report.bias === 'ALTA' && report.demandZone) {
                const risk = report.demandZone.high - report.demandZone.low;
                report.buyPlan = {
                    title: "Plano de Compra (Viés de Alta)",
                    entry: report.demandZone.high,
                    stop: report.demandZone.low,
                    target: report.demandZone.high + (risk * 2)
                };
            } else if (report.bias === 'BAIXA' && report.supplyZone) {
                 const risk = report.supplyZone.high - report.supplyZone.low;
                report.sellPlan = {
                    title: "Plano de Venda (Viés de Baixa)",
                    entry: report.supplyZone.low,
                    stop: report.supplyZone.high,
                    target: report.supplyZone.low - (risk * 2)
                };
            } else if (report.bias === 'LATERAL') {
                const resistance = Math.max(lastHigh.candle.h, prevHigh.candle.h);
                const support = Math.min(lastLow.candle.l, prevLow.candle.l);
                
                report.sellPlan = {
                    title: "Plano de Venda (Resistência)",
                    entry: resistance,
                    stop: resistance * 1.005,
                    target: support
                };
                report.buyPlan = {
                    title: "Plano de Compra (Suporte)",
                    entry: support,
                    stop: support * 0.995,
                    target: resistance
                };
            }

            return report;
        };

        function renderUI(report, timeframe, currentPrice) {
            const { bias, demandZone, supplyZone, bullishFVG, bearishFVG, buyPlan, sellPlan } = report;

            dom.priceDisplay.style.display = 'flex';
            dom.currentPriceElement.textContent = '$' + currentPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            const biasStyles = { ALTA: "bg-green-600 border-green-400", BAIXA: "bg-red-600 border-red-400", LATERAL: "bg-gray-600 border-gray-500" };
            
            const createTradePlanHTML = (plan) => {
                if (!plan) return '';
                const isBuy = plan.title.includes('Compra');
                const colorClass = isBuy ? 'border-green-500' : 'border-red-500';
                return `
                    <div class="p-4 rounded-lg bg-gray-900/70 border-l-4 ${colorClass} space-y-3 mt-4">
                         <h3 class="text-xl font-semibold text-cyan-400 mb-2">${plan.title}</h3>
                         <div class="flex justify-between items-center"><span class="text-gray-400">Entrada:</span><span class="font-mono text-lg text-white">${plan.entry ? plan.entry.toFixed(2) : 'N/A'}</span></div>
                         <div class="flex justify-between items-center"><span class="text-gray-400">Alvo:</span><span class="font-mono text-lg text-green-400">${plan.target ? plan.target.toFixed(2) : 'N/A'}</span></div>
                         <div class="flex justify-between items-center"><span class="text-gray-400">Stop:</span><span class="font-mono text-lg text-red-400">${plan.stop ? plan.stop.toFixed(2) : 'N/A'}</span></div>
                    </div>
                `;
            };

            dom.analysisResultContainer.innerHTML = `
                <div class="grid grid-cols-1 gap-6">
                    <div class="text-center p-6 rounded-lg border-2 shadow-lg ${biasStyles[bias]}">
                        <h2 class="text-xl font-semibold text-white mb-1">VIÉS DO MERCADO (${timeframe.toUpperCase()})</h2>
                        <p class="text-5xl font-bold text-white tracking-wider">${bias}</p>
                    </div>

                    <section>
                        ${createTradePlanHTML(buyPlan)}
                        ${createTradePlanHTML(sellPlan)}
                    </section>

                    <section>
                        <h3 class="flex items-center text-2xl font-bold text-cyan-400 mb-4 border-b-2 border-gray-700 pb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                            Zonas de Interesse (SMC)
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-4 bg-green-900/30 rounded-md border-l-4 border-green-500">
                                <span class="text-gray-300 font-semibold">Zona de Demanda (OB)</span>
                                <span class="font-mono text-lg text-green-400">${demandZone ? `${demandZone.low.toFixed(2)} - ${demandZone.high.toFixed(2)}` : 'N/A'}</span>
                            </div>
                            <div class="flex justify-between items-center p-4 bg-red-900/30 rounded-md border-l-4 border-red-500">
                                <span class="text-gray-300 font-semibold">Zona de Oferta (OB)</span>
                                <span class="font-mono text-lg text-red-400">${supplyZone ? `${supplyZone.low.toFixed(2)} - ${supplyZone.high.toFixed(2)}` : 'N/A'}</span>
                            </div>
                            <div class="flex justify-between items-center p-4 bg-green-900/30 rounded-md border-l-4 border-green-500">
                                <span class="text-gray-300 font-semibold">FVG (Compra)</span>
                                <span class="font-mono text-lg text-green-400">${bullishFVG ? `${bullishFVG.low.toFixed(2)} - ${bullishFVG.high.toFixed(2)}` : 'N/A'}</span>
                            </div>
                            <div class="flex justify-between items-center p-4 bg-red-900/30 rounded-md border-l-4 border-red-500">
                                <span class="text-gray-300 font-semibold">FVG (Venda)</span>
                                <span class="font-mono text-lg text-red-400">${bearishFVG ? `${bearishFVG.low.toFixed(2)} - ${bearishFVG.high.toFixed(2)}` : 'N/A'}</span>
                            </div>
                        </div>
                    </section>
                </div>
            `;
            dom.analysisResultContainer.classList.add('animate-fade-in');
        }

        async function fetchData(timeframe) {
            const now = Date.now();
            const multipliers = { '1h': 5, '1d': 100 };
            const daysToFetch = multipliers[timeframe] || 30;
            const startTime = now - (daysToFetch * 24 * 60 * 60 * 1000);
            const req = { "type": "candleSnapshot", "req": { "coin": "BTC", "interval": timeframe, "startTime": startTime, "endTime": now } };
            const res = await fetch('https://api.hyperliquid.xyz/info', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-cache' }, body: JSON.stringify(req) });
            if (!res.ok) throw new Error(`Falha na API para ${timeframe}.`);
            return (await res.json()).slice(-500).map(c => ({ o: parseFloat(c.o), h: parseFloat(c.h), l: parseFloat(c.l), c: parseFloat(c.c) }));
        }

        async function handleAnalyze() {
            dom.loader.style.display = 'block';
            dom.errorMessage.style.display = 'none';
            dom.analysisResultContainer.style.display = 'none';
            dom.analysisResultContainer.classList.remove('animate-fade-in');
            dom.analyzeButton.disabled = true;

            const selectedTimeframe = dom.timeframeSelector.value;
            const lookback = selectedTimeframe === '1d' ? 10 : 5; // Lógica de lookback ajustável

            try {
                const data = await fetchData(selectedTimeframe);
                
                if (!data || data.length === 0) throw new Error(`Dados para ${selectedTimeframe} não puderam ser carregados.`);
                
                const report = smcAnalysis(data, lookback);
                const currentPrice = data.at(-1).c;
                
                renderUI(report, selectedTimeframe, currentPrice);
                dom.analysisResultContainer.style.display = 'block';

            } catch (e) {
                dom.errorMessage.textContent = `Erro ao buscar dados: ${e.message}. Isso pode ser uma falha temporária da API. Tente novamente em alguns instantes.`;
                dom.errorMessage.style.display = 'block';
            } finally {
                dom.loader.style.display = 'none';
                dom.analyzeButton.disabled = false;
            }
        }
        
        function setup() {
            dom.analyzeButton.addEventListener('click', handleAnalyze);
            dom.timeframeSelector.addEventListener('change', handleAnalyze);
            
            handleAnalyze();
        }

        setup();
    });
    </script>
</body>
</html>
